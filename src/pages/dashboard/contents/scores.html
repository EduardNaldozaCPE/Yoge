<div id="scores-maincontent">
    <form action="#">
        <div class="custom-select">
            <select name="header-dropdown" id="header-dropdown">
                <option value="sequenceId-1">General Fitness Sequence (Sun Salutation A)</option>
                <option value="sequenceId-2">Weight Loss Sequence</option>
                <option value="sequenceId-3">Flexibility Sequence</option>
                <option value="sequenceId-4">Core Strength Sequence</option>
            </select>
        </div>
    </form>
    <div id="score-content">
        <div id="score-stats">
            <div id="score-widget">
                <div class="score-widget-score">
                    <canvas width="150" class="score-widget-canvas" id="score-widget-latest"></canvas>
                    <p>Latest Score</p>
                </div>
                
                <div class="score-widget-score">
                <canvas width="150" class="score-widget-canvas" id="score-widget-best"></canvas>
                    <p>Best Score</p>
                </div>
                
                <div class="score-widget-score">
                <canvas width="150" class="score-widget-canvas" id="score-widget-average"></canvas>
                    <p>Average Score</p>
                </div>
            </div>
            <div id="graph-widget">
                <canvas id="score-graph" width="100%" height="100%"></canvas>
            </div>
        </div>
        <div id="scores-poselist">
            <table>
                <thead>
                    <tr>
                        <th>Pose Name</th>
                        <th>Latest Score</th>
                        <th>Best Score</th>
                        <th>Average Score</th>
                    </tr>
                </thead>
                <tbody id="pose-table-body">
                    <tr>
                        <td>Pose Name</td>
                        <td>0.00</td>
                        <td>0.00</td>
                        <td>0.00</td>
                    </tr>
                    <tr>
                        <td>Pose Name</td>
                        <td>0.00</td>
                        <td>0.00</td>
                        <td>0.00</td>
                    </tr>
                    <tr>
                        <td>Pose Name</td>
                        <td>0.00</td>
                        <td>0.00</td>
                        <td>0.00</td>
                    </tr>
                    <tr>
                        <td>Pose Name</td>
                        <td>0.00</td>
                        <td>0.00</td>
                        <td>0.00</td>
                    </tr>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
    // Charts
    landmarkerAPI.getHistory();
    landmarkerAPI.onHistory((data)=>{
        // Convert datetime int to text
        const _labels = [];
        const _scores = [];
        var bestScore = 0; 
        var latestScore = 0; 
        var avgScore = 0; 
        let scoreSum = 0;
        for (let i = 0; i < data.length; i++) {
            _labels.push(`Session ${i+1}`);
            _scores.push(data[i].score.toFixed(2));
            if (i == data.length-1)
                latestScore = data[i].score;
            if (data[i].score > bestScore)
                bestScore = data[i].score;
            scoreSum += data[i].score;
        }
        avgScore = scoreSum / data.length;

        const chart_canvas = document.getElementById('score-graph');
        const chart_ctx = chart_canvas.getContext('2d');
        const chartData = {
            labels: _labels,
            datasets: [{
                label: 'Session Score',
                data: _scores,
                fill: false,
                borderColor: '#6acb62',
                tension: 0.1
            }]
        }

        new Chart(chart_ctx, {
            type: 'line',
            data: chartData,
            options: {
                aspectRatio: 2,
                scales: {
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        grid: {color:"#444"}
                    },
                    x: {
                        grid: {color:"#444"}
                    }
                }
            }
        });

        // Score Gauges
        const latest_canvas = document.getElementById('score-widget-latest');
        const best_canvas = document.getElementById('score-widget-best');
        const avg_canvas = document.getElementById('score-widget-average');
        const latest_ctx = latest_canvas.getContext('2d');
        const best_ctx = best_canvas.getContext('2d');
        const avg_ctx = avg_canvas.getContext('2d');
        drawGauge(latest_canvas, latest_ctx, latestScore.toFixed(2), '#ddd');
        drawGauge(best_canvas, best_ctx, bestScore.toFixed(2), '#ddd');
        drawGauge(avg_canvas, avg_ctx, avgScore.toFixed(2), '#ddd');
    });

    // Function to draw the gauge
    function drawGauge(canvas, context, percentage, colour) {
        let startAngle = -Math.PI / 2;
        let endAngle = startAngle + (2 * Math.PI * percentage / 100);
        let radius = 60;
        let lineWidth = 20;
        context.clearRect(0, 0, canvas.width, canvas.height);

        context.beginPath();
        context.arc(canvas.width / 2, canvas.height / 2, radius, startAngle, 360);
        context.lineWidth = lineWidth;
        context.strokeStyle = "#333a";
        context.lineCap = "round";
        context.stroke();
        context.closePath();

        context.beginPath();
        context.arc(canvas.width / 2, canvas.height / 2, radius, startAngle, endAngle);
        context.lineWidth = lineWidth;
        context.strokeStyle = colour;
        context.lineCap = "round";
        context.stroke();
        context.closePath();

        context.font = 'bold 45px WorkSans';
        context.font
        context.fillStyle = '#ddd';
        context.textAlign = 'center';
        context.textBaseline = 'middle';
        context.fillText(percentage, canvas.width / 2, canvas.height / 2);
    }
</script>