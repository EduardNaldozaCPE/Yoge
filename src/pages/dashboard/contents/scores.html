<div id="scores-maincontent">
    <form action="#">
        <div class="custom-select">
            <select name="header-dropdown" id="header-dropdown" onchange="getHistory(parseInt(this.value))">
                <option value="1">General Fitness Sequence (Sun Salutation A)</option>
                <option value="2">Weight Loss Sequence</option>
                <option value="3">Flexibility Sequence</option>
                <option value="4">Core Strength Sequence</option>
            </select>
        </div>
    </form>
    <div id="score-content">
        <div id="score-stats">
            <div id="score-widget">
                <div class="score-widget-score">
                    <canvas width="150" class="score-widget-canvas" id="score-widget-latest"></canvas>
                    <p>Latest Score</p>
                </div>
                
                <div class="score-widget-score">
                <canvas width="150" class="score-widget-canvas" id="score-widget-best"></canvas>
                    <p>Best Score</p>
                </div>
                
                <div class="score-widget-score">
                <canvas width="150" class="score-widget-canvas" id="score-widget-average"></canvas>
                    <p>Average Score</p>
                </div>
            </div>
            <div id="graph-widget">
                <canvas id="score-graph" width="100%" height="100%"></canvas>
            </div>
        </div>
        <div id="scores-poselist">
            <table>
                <thead>
                    <tr>
                        <th>Pose Name</th>
                        <th>Latest Score</th>
                        <th>Best Score</th>
                        <th>Average Score</th>
                    </tr>
                </thead>
                <tbody id="pose-table-body">
                    <tr>
                        <td>Pose Name</td>
                        <td>0.00</td>
                        <td>0.00</td>
                        <td>0.00</td>
                    </tr>
                    <tr>
                        <td>Pose Name</td>
                        <td>0.00</td>
                        <td>0.00</td>
                        <td>0.00</td>
                    </tr>
                    <tr>
                        <td>Pose Name</td>
                        <td>0.00</td>
                        <td>0.00</td>
                        <td>0.00</td>
                    </tr>
                    <tr>
                        <td>Pose Name</td>
                        <td>0.00</td>
                        <td>0.00</td>
                        <td>0.00</td>
                    </tr>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
    // Reassign variables on reload.
    if (latest_canvas === undefined)
        var latest_canvas = document.getElementById('score-widget-latest');
    else
        latest_canvas = document.getElementById('score-widget-latest');
    if (best_canvas === undefined)
        var best_canvas = document.getElementById('score-widget-best');
    else
        best_canvas = document.getElementById('score-widget-best');
    if (avg_canvas === undefined)
        var avg_canvas = document.getElementById('score-widget-average');
    else
        avg_canvas = document.getElementById('score-widget-average');
    if (chart_canvas === undefined)
        var chart_canvas = document.getElementById('score-graph');
    else
        chart_canvas = document.getElementById('score-graph');
    if (latest_ctx === undefined)
        var latest_ctx = latest_canvas.getContext('2d');
    else
        latest_ctx = latest_canvas.getContext('2d');
    if (best_ctx === undefined)
        var best_ctx = best_canvas.getContext('2d');
    else
        best_ctx = best_canvas.getContext('2d');
    if (avg_ctx === undefined)
        var avg_ctx = avg_canvas.getContext('2d');
    else
        avg_ctx = avg_canvas.getContext('2d');
    if (chart_ctx === undefined)
        var chart_ctx = chart_canvas.getContext('2d');
    else
        chart_ctx = chart_canvas.getContext('2d');
    
    var chart;
    var _labels = [];
    var _scores = [];
    var selectedSequenceId = 1;
    var bestScore   = 0;
    var latestScore = 0; 
    var avgScore    = 0; 
    var chartData = {
            labels: [],
            datasets: [{
                label: 'Session Score',
                data: [],
                fill: false,
                borderColor: '#6acb62',
                tension: 0.1
            }]
        }

    getHistory(selectedSequenceId);
    function getHistory(sequenceId) {
        if (typeof(sequenceId) != 'number') {
            console.error("getHistory invalid argument");
            return;
        }
        selectedSequenceId = sequenceId;
        
        landmarkerAPI.getHistory(selectedSequenceId);
        landmarkerAPI.getPoseRecords(selectedSequenceId);
    }
    landmarkerAPI.onHistory((data)=>{
        _labels = [];   
        _scores = [];
        bestScore   = 0;
        latestScore = 0; 
        avgScore    = 0;

        let scoreSum = 0;
        if (data.length != 0) {
            for (let i = 0; i < data.length; i++) {
                _labels.push(`Session ${i+1}`);
                _scores.push(data[i].score.toFixed(2));
                if (i == data.length-1)
                    latestScore = data[i].score;
                if (data[i].score > bestScore)
                    bestScore = data[i].score;
                scoreSum += data[i].score;
            }
            avgScore = scoreSum / data.length;
        }

        chartData = {
            labels: _labels,
            datasets: [{
                label: 'Session Score',
                data: _scores,
                fill: false,
                borderColor: '#6acb62',
                tension: 0.1
            }]
        }

        if(Chart.getChart(chart_ctx)) {
            Chart.getChart(chart_ctx)?.destroy();
        }

        chart = new Chart(chart_ctx, {
            type: 'line',
            data: chartData,
            options: {
                aspectRatio: 2,
                scales: {
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        grid: {color:"#444"}
                    },
                    x: {
                        grid: {color:"#444"}
                    }
                }
            }
        });

        drawGauge(latest_canvas, latest_ctx, latestScore.toFixed(2), '#ddd');
        drawGauge(best_canvas, best_ctx, bestScore.toFixed(2), '#ddd');
        drawGauge(avg_canvas, avg_ctx, avgScore.toFixed(2), '#ddd');
    });

    landmarkerAPI.onPoseRecords((data)=>{
        let newTable = $("#pose-table-body").html("");
        for (let i = 0; i < data.length; i++) {
            newTable = newTable.add(`<tr>
                <td>${data[i].poseName}</td>
                <td>${data[i].latestScore.toFixed(2)}</td>
                <td>${data[i].bestScore.toFixed(2)}</td>
                <td>${data[i].avgScore.toFixed(2)}</td>
            </tr>`);
        }
        $("#pose-table-body").html(newTable);
    });

    // Function to draw the gauge
    function drawGauge(canvas, ctx, percentage, colour) {
        let startAngle  = -Math.PI / 2;
        let endAngle    = startAngle + (2 * Math.PI * percentage / 100);
        let radius      = 60;
        let lineWidth   = 20;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.beginPath();
        ctx.arc(canvas.width / 2, canvas.height / 2, radius, startAngle, 360);
        ctx.lineWidth = lineWidth;
        ctx.strokeStyle = "#333a";
        ctx.lineCap = "round";
        ctx.stroke();
        ctx.closePath();

        ctx.beginPath();
        ctx.arc(canvas.width / 2, canvas.height / 2, radius, startAngle, endAngle);
        ctx.lineWidth = lineWidth;
        ctx.strokeStyle = colour;
        ctx.lineCap = "round";
        ctx.stroke();
        ctx.closePath();
        
        ctx.font = 'bold 45px WorkSans';
        ctx.fillStyle = '#ddd';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(percentage, canvas.width / 2, canvas.height / 2);
    }
</script>